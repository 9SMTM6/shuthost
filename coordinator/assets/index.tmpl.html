<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ShutHost Coordinator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{description}">
    <meta name="theme-color" content="#4CAF50">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <style>
        /* {styles} */
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans min-h-screen">
    <header class="bg-white dark:bg-gray-800 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-14">
                <div class="flex items-center gap-4">
                    <img src="/favicon.svg" alt="ShutHost Logo" class="h-6 sm:h-8 w-auto">
                    <h1 class="text-xl sm:text-2xl font-semibold text-gray-800 dark:text-gray-100">ShutHost</h1>
                </div>
                <nav class="flex">
                    <button class="tab" data-tab="architecture">Documentation</button>
                    <button class="tab active" data-tab="hosts">Hosts</button>
                    <button class="tab" data-tab="clients">Clients</button>
                </nav>
            </div>
        </div>
    </header>

    <div class="main px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto w-full">
        <main class="py-4 sm:py-6">
            <div id="hosts-tab" class="tab-content active">
                <!-- Install Instructions Panel -->
                <div class="section-container mt-0 py-0">
                    <div class="collapsible-header py-2" data-target="host-install-content">
                        <h2 class="section-title mb-0 text-base">Install Host Agent</h2>
                        <span class="collapsible-icon"></span>
                    </div>
                    <div id="host-install-content" class="collapsible-content">
                        <p class="mb-1 text-sm">Run the following command in your terminal:</p>
                        <div class="code-container py-2">
                            <button class="copy-button" data-copy-target="#host-install-command">Copy</button>
                            <code id="host-install-command" class="code-block">Loading...</code>
                        </div>
                        <p class="description-text text-xs">Adjust options as needed. Add the output to the hosts
                            section of your config on the Coordinator Host:</p>
                        <div class="code-container">
                            <button class="copy-button" data-copy-target="#config-location">Copy</button>
                            <code id="config-location" class="code-block">{coordinator_config}</code>
                        </div>

                        <!-- Agent Installation Requirements & Gotchas -->
                        <div class="alert alert-warning">
                            <div class="alert-title">‚ö†Ô∏è Agent Installation Requirements</div>
                            <ul>
                                <li><strong>Superuser Access:</strong> The installer requires curl and will install as
                                    superuser (root/sudo/doas)</li>
                                <li><strong>Unprotected Resources:</strong> Installation requires access to unprotected
                                    download endpoints (see security notes below)</li>
                                <li><strong>Static IP Required:</strong> The host needs a static IP address for shutdown
                                    commands and online status monitoring</li>
                                <li><strong>Manual Configuration:</strong> The generated config must be manually added
                                    to your coordinator configuration file</li>
                            </ul>
                        </div>

                        <div class="alert alert-error">
                            <div class="alert-title">üö´ Platform Limitations</div>
                            <ul>
                                <li><strong>No Windows Support:</strong> Only Linux distributions are supported.</li>
                                <li><strong>No BSD Support:</strong> BSD-based systems are not supported.</li>
                                <li><strong>Docker Networking Issues:</strong> Docker on macOS won't work for the coordinator due to network broadcast requirements. Use the single binary instead. On Linux use <code>network_mode: host</code> or also use the binary.</li>
                            </ul>
                        </div>

                        <div class="alert alert-info">
                            <div class="alert-title">üí° Wake-on-LAN (WOL) Requirements</div>
                            <p>The agent requires Wake-on-LAN for remote startup functionality:</p>
                            <ul>
                                <li><strong>Motherboard Support:</strong> Your motherboard must support WOL.
                                    <ul>
                                        <li><strong>BIOS Configuration:</strong> WOL must be enabled in BIOS/UEFI settings.</li>
                                        <li><strong>Power State Limitation:</strong> Some systems only support WOL from sleep mode, not full shutdown.</li>
                                    </ul>
                                </li>
                                <li><strong>OS Configuration:</strong> WOL must be enabled in the operating system.</li>
                                <li><strong>Network Requirements:</strong> Requires network broadcast support and host reachability.
                                    <ul>
                                        <li><em>Note: The installer tests network reachability but won't fail if the test is unsuccessful, so ensure your network supports broadcast for WOL to work properly.</em></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Hosts Table -->
                <div class="section-container mt-4">
                    <div class="table-wrapper">
                        <table class="w-full">
                            <thead>
                                <tr id="host-table-header">
                                    <th class="table-header">Host</th>
                                    <th class="table-header">Status</th>
                                    <th class="table-header">Leases</th>
                                    <th class="table-header">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="host-table-body" class="divide-y divide-gray-200">
                                <!-- Hosts will be loaded here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="clients-tab" class="tab-content">
                <!-- Install Instructions Panel -->
                <div class="section-container mt-0 py-0">
                    <div class="collapsible-header py-2" data-target="client-install-content">
                        <h2 class="section-title mb-0 text-base">Install Client</h2>
                        <span class="collapsible-icon"></span>
                    </div>
                    <div id="client-install-content" class="collapsible-content">
                        <p class="mb-1 text-sm">Run the following command in your terminal:</p>
                        <div class="code-container py-2">
                            <button class="copy-button" data-copy-target="#client-install-command">Copy</button>
                            <code id="client-install-command" class="code-block">Loading...</code>
                        </div>
                        <p class="description-text text-xs">Optionally, you can specify a custom client ID as the second
                            argument. Add the output to the clients section of your config on the Coordinator Host:</p>
                        <div class="code-container">
                            <button class="copy-button" data-copy-target="#config-location">Copy</button>
                            <code id="config-location" class="code-block">{coordinator_config}</code>
                        </div>

                        <!-- Client Installation Requirements & Gotchas -->
                        <div class="alert alert-warning">
                            <div class="alert-title">‚ö†Ô∏è Client Installation Requirements</div>
                            <ul>
                                <li><strong>Dependencies:</strong> Installer requires curl; client runtime requires
                                    OpenSSL</li>
                                <li><strong>Unprotected Resources:</strong> Installation requires access to unprotected
                                    download endpoints (see security notes below)</li>
                                <li><strong>Manual Configuration:</strong> The generated config must be manually added
                                    to your coordinator configuration file</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Clients Table -->
                <div class="section-container mt-4">
                    <div class="table-wrapper">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="table-header">Client ID</th>
                                    <th class="table-header">Leases</th>
                                    <th class="table-header">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="client-table-body" class="divide-y divide-gray-200">
                                <!-- Clients will be loaded here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="architecture-tab" class="tab-content">
                <div class="section-container mt-4">
                    <h2 class="section-title px-4 pt-4">Architecture Documentation</h2>
                    <p class="description-text px-4">ShutHost provides two different architectural views depending on your use case:</p>

                    <div class="architecture-section">
                        <h3 class="architecture-title px-4">Simplified Architecture</h3>
                        <div class="architecture-diagram-container">
                            <img src="/architecture_simplified.svg" alt="Simplified Architecture Diagram" class="architecture-diagram">
                        </div>
                        
                        <div class="architecture-content">
                            <p class="architecture-when-to-use px-4">
                                <strong>When to use:</strong> This architecture applies when you have <strong>no clients defined</strong> in your configuration. 
                                In this scenario, only the WebUI interacts with hosts through the coordinator.
                            </p>
                            
                            <div class="alert alert-info">
                                <div class="alert-title">How it works</div>
                                <ul class="text-sm">
                                    <li>The <strong>WebUI</strong> sends startup/shutdown requests directly to the <strong>Coordinator</strong></li>
                                    <li>The <strong>Coordinator</strong> manages host lifecycle by sending Wake-on-LAN packets for startup and shutdown commands to agents</li>
                                    <li>Each <strong>Host</strong> runs an <strong>Agent</strong> service that handles shutdown commands and reports status back to the coordinator</li>
                                    <li>Under the hood, this still uses the lease system, but it's transparent to the user</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="architecture-separator">
                        <h3 class="architecture-title px-4">Complete Architecture</h3>
                        <div class="architecture-diagram-container">
                            <img src="/architecture.svg" alt="Complete Architecture Diagram" class="architecture-diagram">
                        </div>
                        
                        <div class="architecture-content">
                            <p class="architecture-when-to-use px-4">
                                <strong>When to use:</strong> This architecture applies when you have <strong>clients defined</strong> in your configuration. 
                                This enables programmatic access where multiple clients can access hosts concurrently.
                            </p>
                            
                            <div class="alert alert-warning">
                                <div class="alert-title">Lease System</div>
                                <p class="text-sm">
                                    With multiple clients potentially accessing hosts simultaneously, ShutHost introduces a 
                                    <strong>lease system</strong> to coordinate access and prevent conflicts:
                                </p>
                                <ul class="text-sm mt-2">
                                    <li><strong>Lease Acquisition:</strong> Both WebUI and Clients must request leases before using hosts</li>
                                    <li><strong>Automatic Startup:</strong> Hosts are automatically started when the first lease is acquired (‚â•1 leases)</li>
                                    <li><strong>Automatic Shutdown:</strong> Hosts are automatically shut down when all leases are released (=0 leases)</li>
                                    <li><strong>Conflict Prevention:</strong> The lease system ensures hosts aren't shut down while still in use by other clients</li>
                                </ul>
                            </div>
                            
                            <div class="alert alert-info">
                                <div class="alert-title">Client Use Cases</div>
                                <p class="text-sm">Clients are typically used for:</p>
                                <ul class="text-sm mt-2">
                                    <li><strong>Automated Backups:</strong> Scripts that need to wake up hosts, perform backups, then allow shutdown</li>
                                    <li><strong>Batch Processing:</strong> Jobs that require access to specific hosts for processing tasks</li>
                                    <li><strong>CI/CD Pipelines:</strong> Build systems that need temporary access to powerful build machines</li>
                                    <li><strong>Scheduled Maintenance:</strong> Scripts that perform regular maintenance tasks on hosts</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="architecture-key-points">
                        <div class="alert alert-info">
                            <div class="alert-title">üí° Key Points</div>
                            <ul class="text-sm">
                                <li><strong>Both architectures use leases internally</strong> - the simplified view just hides this complexity</li>
                                <li><strong>Wake-on-LAN (WOL)</strong> is used for remote host startup in both cases</li>
                                <li><strong>Agents report status</strong> to keep the coordinator informed of host availability</li>
                                <li><strong>The coordinator serves the WebUI</strong> and provides the API for both human and programmatic access</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Configuration Panel (shown on both tabs) -->
            <div class="section-container mt-4">
                <div class="collapsible-header collapsed" data-target="security-config-content">
                    <h2 class="section-title mb-0 text-base">üîí Required Security Exceptions</h2>
                    <span class="collapsible-icon"></span>
                </div>
                <div id="security-config-content" class="collapsible-content collapsed">
                    <div class="alert alert-info">
                        <div class="alert-title">Authentication Bypass Required</div>
                        <p>For the web app and installation scripts to work properly, certain endpoints must be accessible without authentication. If you're using a reverse proxy with authentication (like Authelia, NPM with auth, etc.), you need to configure bypass rules for:</p>
                        <ul>
                            <li><code>/download/*</code> - Installation script downloads</li>
                            <li><code>/api/m2m/*</code> - Machine-to-machine API communication</li>
                            <li><code>/manifest.json</code> - PWA manifest (required for browser compatibility)</li>
                            <li><code>/favicon.ico</code> - Favicon (required for browser compatibility)</li>
                        </ul>
                        <p class="text-xs mt-2"><em>This allows the installer scripts and web app to download necessary files and communicate with the coordinator API without requiring user authentication. The manifest and favicon exceptions are required for proper browser and PWA support.</em></p>
                    </div>

                    <div class="alert alert-warning">
                        <div class="alert-title">Configuration Examples</div>

                        <p class="text-sm font-semibold mb-2">Authelia:</p>
                        <div class="code-container">
                            <button class="copy-button" data-copy-target="#authelia-config">Copy</button>
                            <code id="authelia-config" class="code-block">Loading...</code>
                        </div>

                        <p class="text-sm font-semibold mb-2 mt-4">Nginx Proxy Manager with Authentication:</p>
                        <div class="code-container">
                            <button class="copy-button" data-copy-target="#nginx-config">Copy</button>
                            <code id="nginx-config" class="code-block"># In your proxy host's advanced configuration
location ~ ^/(download|api/m2m|manifest.json|favicon.ico)$ {
    auth_basic off;
    proxy_pass http://your-shuthost-backend;
}</code>
                        </div>

                        <p class="text-sm font-semibold mb-2 mt-4">Traefik with ForwardAuth:</p>
                        <div class="code-container">
                            <button class="copy-button" data-copy-target="#traefik-config">Copy</button>
                            <code id="traefik-config" class="code-block">Loading...</code>
                        </div>

                        <p class="text-xs mt-2"><em>Replace backend references with your actual configuration values.</em></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer
        class="bg-white dark:bg-gray-800 shadow-md py-2 px-4 text-center text-gray-600 dark:text-gray-400 text-xs mt-auto">
        ShutHost Coordinator v{version}
    </footer>

    <script>
        { js }
    </script>
</body>

</html>