name: Test Released Install Scripts

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["Build, Test and Release"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  test-install-scripts:
    name: Test ${{ matrix.component }} install script on ${{ matrix.name_suffix }}
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}
    env:
      GH_TOKEN: ${{ github.token }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - component: coordinator
            os: ubuntu-latest
            name_suffix: Ubuntu
          - component: coordinator
            os: macos-latest
            name_suffix: macOS
          - component: coordinator
            os: ubuntu-latest
            container: docker.io/heywoodlh/openrc:latest
            prepare: true
            name_suffix: Alpine
          - component: host_agent
            os: ubuntu-latest
            name_suffix: Ubuntu
          - component: host_agent
            os: macos-latest
            name_suffix: macOS
          - component: host_agent
            os: ubuntu-latest
            container: docker.io/heywoodlh/openrc:latest
            prepare: true
            name_suffix: Alpine
    steps:
      - name: Set tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            TAG=$(git tag --points-at ${{ github.event.workflow_run.head_sha }} | head -1)
            echo "TAG=$TAG" >> $GITHUB_ENV
          fi
      - name: Prepare Alpine
        if: matrix.prepare
        run: |
          apk add --no-cache curl doas github-cli git
          echo "permit nopass root" >> /etc/doas.conf
      - name: Download install scripts
        run: |
          gh release download ${{ env.TAG }} --repo ${{ github.repository }} --pattern "shuthost_${{ matrix.component }}_installer.sh" --dir install-scripts
      - name: Make scripts executable
        run: chmod +x install-scripts/*.sh
      - name: Test ${{ matrix.component }} install script
        run: |
          CI_MODE=true ./install-scripts/shuthost_${{ matrix.component }}_installer.sh

  test-windows-host-agent-install:
    name: Test host_agent install script on Windows
    runs-on: windows-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Set tag
        shell: powershell
        run: |
          if ($env:GITHUB_EVENT_NAME -eq "release") {
            echo "TAG=${{ github.event.release.tag_name }}" >> $env:GITHUB_ENV
          } elseif ($env:GITHUB_EVENT_NAME -eq "workflow_run") {
            $TAG = git tag --points-at ${{ github.event.workflow_run.head_sha }} | Select-Object -First 1
            echo "TAG=$TAG" >> $env:GITHUB_ENV
          }
      - name: Download install scripts
        run: |
          gh release download ${{ env.TAG }} --repo ${{ github.repository }} --pattern "shuthost_host_agent_installer.ps1" --dir install-scripts
      - name: Test host_agent install script
        shell: powershell
        run: |
          $env:CI_MODE="true"
          powershell -ExecutionPolicy Bypass -File .\install-scripts\shuthost_host_agent_installer.ps1
