on: [push]

# These tests are considered irrelevant for a proper deployment, but sure are nice to have correct most of the time.
name: QualityAssurance

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: &checkout actions/checkout@v6
      - run: rustup update stable
      - run: rustup component add rustfmt
      - uses: &rust-cache Swatinem/rust-cache@v2
      - run: cargo +stable --locked fmt --all -- --check
  cargo-deny:
    runs-on: ubuntu-latest
    steps:
      - uses: *checkout
      - uses: EmbarkStudios/cargo-deny-action@v2
        with:
          rust-version: stable
  spell-check:
    runs-on: ubuntu-latest
    steps:
      - uses: *checkout
      - name: Check spelling of entire workspace
        uses: crate-ci/typos@master
  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: *checkout
      - run: rustup update stable
      - run: rustup component add clippy
      - uses: *rust-cache
      - run: cargo +stable clippy --workspace -- -D warnings

  sqlx-offline-cache:
    name: sqlx offline cache check with prepare
    runs-on: ubuntu-latest
    steps:
      - uses: *checkout
      - run: rustup update stable
      - run: cargo install sqlx-cli --no-default-features --features sqlite --locked
      - run: cargo sqlx prepare --check --workspace

  coverage:
    name: Coverage report (llvm-cov)
    runs-on: ubuntu-latest

    steps:
      - uses: *checkout
        with:
          lfs: false
          fetch-depth: 0

      - name: Fetch LFS objects (exclude webp)
        run: |
          # fetch LFS objects but exclude large webp files to save bandwidth
          git lfs fetch --exclude="*.webp" || true

      - name: Check LFS availability
        run: |
          AVAIL=$(./scripts/check_lfs_fetched.sh "frontend/tests/mobile-navigation.spec.ts-snapshots/mobile-navigation-Mobile-Dark.png")
          echo "LFS_AVAILABLE=$AVAIL" >> $GITHUB_ENV
          echo "LFS availability: $AVAIL"

      - name: Install test fonts (Inter & Cascadia Code)
        run: |
          set -eux
          # Ubuntu fonts; fail if they can't be installed.
          sudo apt-get update
          sudo apt-get install -y fonts-inter fonts-cascadia-code
          # Verify via fc-list; if fc-list isn't present this will fail which
          # is desired so the CI run fails when fonts are not available.
          fc-list | grep -i inter >/dev/null 2>&1 || { echo "Inter font not found after install" >&2; exit 1; }
          fc-list | grep -i cascadia >/dev/null 2>&1 || { echo "Cascadia Code not found after install" >&2; exit 1; }
          sudo fc-cache -f -v

      - name: Install node deps, Playwright Chromium and system deps
        run: |
          cd frontend
          npm ci
          npm run install-chromium-ci

      - run: rustup update stable

      # - uses: *rust-cache

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      # running these in an individual step didn't work.
      - name: Generate coverage reports based on playwright and Rust tests
        env:
          CI: true
          COVERAGE: 1
          SKIP_BUILD: 1
          # fix EAGAIN errors due to process exhaustion in GitHub CI
          CARGO_BUILD_JOBS: 1
        run: |
          set -e
          set -v
          eval "$(cargo llvm-cov show-env --export-prefix --remap-path-prefix)"
          cargo llvm-cov clean --workspace
          . ./scripts/helpers.sh && build_gnu
          if [ "$LFS_AVAILABLE" = "true" ]; then
            cd frontend && npx playwright test && cd ..
          else
            echo "Skipping Playwright tests due to LFS quota"
          fi
          ./scripts/build-gh-pages.sh --provided-binary=target/debug/shuthost_coordinator
          cargo test --workspace --all-targets
          ./scripts/tests/direct-control-ubuntu.sh ./target/debug/shuthost_host_agent
          ./scripts/tests/service-installation-systemd.sh ./target/debug/shuthost_coordinator
          ./scripts/snapshot_files/systemd.sh ./target/debug/shuthost_coordinator
          . ./scripts/helpers.sh && build_musl
          ./scripts/tests/direct-control-alpine.sh ./target/debug/shuthost_host_agent
          ./scripts/tests/direct-control-pwsh.sh ./target/debug/shuthost_host_agent
          ./scripts/tests/service-installation-openrc.sh ./target/debug/shuthost_coordinator
          ./scripts/snapshot_files/compose_and_self_extracting.sh ./target/debug/shuthost_coordinator
          cargo llvm-cov report --lcov --output-path lcov.info --ignore-filename-regex ".*cargo/registry/src/.*|tests/rs_integration/.*"
          cargo llvm-cov report --html --output-dir target/coverage --ignore-filename-regex ".*cargo/registry/src/.*|tests/rs_integration/.*"

      - name: Upload coverage artifacts (HTML + LCOV)
        uses: actions/upload-artifact@v5
        with:
          name: coverage-reports
          path: |
            ./target/coverage/
            ./lcov.info

      - name: Check for excessive changes in lcov.info (its not really stable)
        if: env.LFS_AVAILABLE == 'true'
        run: |
          if git diff --quiet lcov.info; then
            echo "lcov.info is unchanged."
          else
            OLD_SIZE=$(git show HEAD:lcov.info | grep '^size ' | cut -d' ' -f2)
            NEW_SIZE=$(wc -c < lcov.info)
            SIZE_DIFF=$((NEW_SIZE - OLD_SIZE))
            ABS_SIZE_DIFF=$(( SIZE_DIFF < 0 ? -SIZE_DIFF : SIZE_DIFF ))
            PERCENT_SIZE_CHANGE=$((ABS_SIZE_DIFF * 100 / OLD_SIZE))
            echo "lcov.info size change: $PERCENT_SIZE_CHANGE%"
            if [ $PERCENT_SIZE_CHANGE -gt 5 ]; then
              echo "Excessive size change detected in lcov.info. Consider updating."
              exit 1
            fi
          fi

  docker-examples:
    name: Test Docker examples (compose and CLI)
    runs-on: ubuntu-latest
    steps:
      - uses: *checkout

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test docker-compose config validation
        working-directory: docs/examples
        run: |
          docker compose config
          docker compose pull

  install-script-test:
    name: Test automated install script
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: *checkout
      - &install-coordinator
        run: |
          CI_MODE=true ./scripts/enduser_installers/coordinator.sh

  install-script-test-alpine:
    name: Test automated install script on Alpine
    runs-on: ubuntu-latest
    container: docker.io/heywoodlh/openrc:latest
    steps:
      - uses: *checkout
      - &prepare_alpine
        name: Prepare
        run: |
          apk add --no-cache curl doas
          echo "permit nopass root" >> /etc/doas.conf
      - *install-coordinator

  host-agent-script-test:
    name: Test automated host agent install script
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: *checkout
      - &install-host-agent
        run: |
          CI_MODE=true ./scripts/enduser_installers/host_agent.sh
      - &generate-direct-control
        name: Generate direct control script
        run: |
          if command -v doas >/dev/null; then doas shuthost_host_agent generate-direct-control; else sudo shuthost_host_agent generate-direct-control; fi

  host-agent-script-test-alpine:
    name: Test automated host agent install script on Alpine
    runs-on: ubuntu-latest
    container: docker.io/heywoodlh/openrc:latest
    steps:
      - uses: *checkout
      - *prepare_alpine
      - *install-host-agent
      - *generate-direct-control

  host-agent-script-test-windows:
    name: Test automated host agent install script on Windows
    runs-on: windows-latest
    steps:
      - uses: *checkout
      - name: Install host agent
        run: |
          curl.exe -fLO "https://github.com/9SMTM6/shuthost/releases/latest/download/shuthost_host_agent_installer.ps1"
          powershell -ExecutionPolicy Bypass -File .\shuthost_host_agent_installer.ps1
      - name: Generate direct control script
        run: |
          powershell -ExecutionPolicy Bypass -File .\shuthost_host_agent_self_extracting.ps1 generate-direct-control

  lfs-availability-test:
    name: Test LFS Availability
    runs-on: ubuntu-latest
    steps:
      - uses: *checkout
        with:
          lfs: false
      - name: Test LFS availability with minimal bandwidth
        run: |
          # Try to fetch a small LFS file to test if quota allows any LFS access
          # Using one of the smallest PNG files (~37 KB) to minimize bandwidth usage
          target="frontend/tests/mobile-navigation.spec.ts-snapshots/mobile-navigation-Mobile-Dark.png"
          git lfs fetch --include="$target" || true
          AVAIL=$(./scripts/check_lfs_fetched.sh "$target")
          echo "LFS_AVAILABLE=$AVAIL" >> $GITHUB_ENV
          if [ "$AVAIL" != "true" ]; then
            echo "LFS bandwidth quota exceeded - CI functionality is limited"
            exit 1
          else
            echo "LFS is available"
          fi
